<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CashApp</title>

<style>
/* ---------------------- */
/*        Ø§Ù„ØªØµÙ…ÙŠÙ…         */
/* ---------------------- */

:root {
  --bg: #ffffff;
  --text: #000;
  --primary: #1db954;
  --card: #f1f1f1;
}

body.dark {
  --bg: #111;
  --text: #fff;
  --card: #222;
}

body {
  margin: 0;
  font-family: sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: var(--card);
  border-bottom: 1px solid #ccc;
}

#logo {
  font-size: 24px;
  font-weight: bold;
  display: flex;
  gap: 8px;
  align-items: center;
}

#logo span {
  background: var(--primary);
  color: #fff;
  padding: 5px 8px;
  border-radius: 5px;
}

button {
  padding: 8px 14px;
  background: var(--primary);
  border: none;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
}

.card {
  background: var(--card);
  padding: 15px;
  margin: 15px;
  border-radius: 8px;
}

input, textarea {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #aaa;
}

#popup {
  position: fixed;
  top: 0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
}

#popupBox {
  background: var(--bg);
  padding: 20px;
  width: 90%;
  max-width: 350px;
  border-radius: 8px;
}
</style>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, update, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAKGrxv_GT3T3krYeYY5C-o7VmvLkG-gw0",
    authDomain: "cashapp-405b7.firebaseapp.com",
    databaseURL: "https://cashapp-405b7-default-rtdb.firebaseio.com",
    projectId: "cashapp-405b7",
    storageBucket: "cashapp-405b7.firebasestorage.app",
    messagingSenderId: "146496743526",
    appId: "1:146496743526:web:edc0318c7f3affa25465a7",
    measurementId: "G-NWMR38V1B9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.db = db;
window.refDB = ref;
window.childDB = child;
window.getDB = get;
window.setDB = set;
window.updateDB = update;
</script>

</head>
<body>

<header>
  <div id="logo"><span>ğŸ’²</span> CashApp</div>
  <div>
    <button onclick="toggleTheme()">ğŸŒ™</button>
    <button onclick="toggleLang()">ğŸŒ</button>
    <button id="loginBtn" onclick="openLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div id="userInfo" class="card" style="display:none;"></div>

<div class="card">
  <input id="searchStore" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØªØ§Ø¬Ø±">
  <button onclick="createStoreBox()">Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø±</button>
</div>

<div id="storeArea" class="card"></div>

<div class="card">
  <h3>Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
  <input id="toID" placeholder="Ø§ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…">
  <input id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="sendMoney()">ØªØ­ÙˆÙŠÙ„</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="popup">
  <div id="popupBox">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="username" placeholder="Ø§Ù„Ø§Ø³Ù…">
    <input id="passcode" placeholder="Ø§Ù„Ø±Ù…Ø²">
    <button onclick="login()">ØªØ³Ø¬ÙŠÙ„</button>
    <button onclick="closeLogin()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script>
// ======================
//  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø«ÙŠÙ…
// ======================
function toggleTheme(){
  document.body.classList.toggle("dark");
}

function toggleLang(){
  if(document.documentElement.lang === "ar"){
    document.documentElement.lang = "en";
    document.documentElement.dir = "ltr";
  } else {
    document.documentElement.lang = "ar";
    document.documentElement.dir = "rtl";
  }
}

// ======================
//  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// ======================
function openLogin(){ popup.style.display="flex"; }
function closeLogin(){ popup.style.display="none"; }

let user = null;

async function login(){
  let name = username.value.trim();
  let code = passcode.value.trim();

  if(!name || !code){ alert("Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

  let userID = code.padStart(11, "0");

  let userRef = childDB(refDB(db), "users/" + userID);
  let snap = await getDB(userRef);

  if(!snap.exists()){
    await setDB(userRef, {
      name: name,
      id: userID,
      money: 0,
      store: {},
      products: {}
    });
  }

  user = (await getDB(userRef)).val();

  localStorage.setItem("userID", userID);

  updateUI();
  closeLogin();
}

function logout(){
  localStorage.removeItem("userID");
  user = null;
  updateUI();
}

async function loadUser(){
  let uid = localStorage.getItem("userID");
  if(uid){
    let snap = await getDB(childDB(refDB(db),"users/"+uid));
    if(snap.exists()){
      user = snap.val();
    }
  }
  updateUI();
}

function updateUI(){
  if(user){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    userInfo.style.display="block";

    userInfo.innerHTML = `
      <h3>${user.name}</h3>
      <p>Ø§Ù„Ø±ØµÙŠØ¯: ${user.money}$</p>
      <p>Ø§ÙŠØ¯ÙŠ: ${user.id}</p>
    `;
  } else {
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    userInfo.style.display="none";
  }
}

// ======================
//  Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø±
// ======================
function createStoreBox(){
  if(!user){ alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„"); return; }

  let name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±:");
  if(!name) return;

  let desc = prompt("ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):");

  user.store = {
    name: name,
    desc: desc || "",
  };

  updateDB(refDB(db, "users/"+user.id+"/store"), user.store);
  alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±");
}

// ======================
//  Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
// ======================
async function addProduct(){
  if(!user) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„");

  let name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
  let price = prompt("Ø§Ù„Ø³Ø¹Ø±:");

  if(!name || !price) return;

  let productID = Date.now();

  await updateDB(refDB(db,"users/"+user.id+"/products/"+productID), {
    name:name,
    price:Number(price)
  });

  alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
}

// ======================
//  Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ
// ======================
async function sendMoney(){
  if(!user) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„");

  let to = toID.value.trim();
  let amount = Number(amount.value.trim());

  if(!to || !amount) return alert("Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª");

  let fromSnap = await getDB(childDB(refDB(db),"users/"+user.id));
  let toSnap   = await getDB(childDB(refDB(db),"users/"+to));

  if(!toSnap.exists()) return alert("Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  let fromMoney = fromSnap.val().money;
  let toMoney = toSnap.val().money;

  if(fromMoney < amount) return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await updateDB(refDB(db,"users/"+user.id), { money: fromMoney - amount });
  await updateDB(refDB(db,"users/"+to),       { money: toMoney + amount });

  alert("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„");

  loadUser();
}

loadUser();
</script>

</body>
</html>
