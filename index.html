<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CashApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary: #00D632;
            --primary-dark: #00B32A;
            --gray: #2C3E50;
            --light-gray: #ECF0F1;
            --dark: #000000;
            --light: #FFFFFF;
            --dark-gray: #1A252F;
            --error: #FF4757;
            --warning: #FFA502;
            --info: #2ED573;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }

        html {
            font-size: 16px;
            overflow-x: hidden;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        body:lang(en) {
            font-family: 'Poppins', sans-serif;
        }

        .header {
            background: var(--gray);
            padding: 12px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo-icon {
            background: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .logo-text {
            color: white;
            font-size: 22px;
            font-weight: bold;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .auth-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,214,50,0.3);
        }

        .auth-btn.secondary {
            background: transparent;
            border: 2px solid var(--primary);
        }

        .main-content {
            flex: 1;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 15px;
            width: 100%;
        }

        .welcome-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 32px;
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .user-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,214,50,0.2);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-name {
            font-size: 24px;
            font-weight: bold;
        }

        .user-balance {
            font-size: 32px;
            font-weight: bold;
            margin: 5px 0;
        }

        .user-id {
            background: rgba(255,255,255,0.2);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .transfer-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--light-gray);
            padding: 10px;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 3px 10px rgba(0,214,50,0.2);
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            display: none;
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-field-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .field-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .field-value {
            font-size: 14px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 8px;
            border: 2px solid transparent;
        }

        .footer {
            background: var(--gray);
            color: white;
            padding: 25px 0 20px;
            margin-top: 40px;
            width: 100%;
        }

        .footer-content {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 0 15px;
            text-align: center;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .footer-logo-icon {
            background: var(--primary);
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .footer-logo-text {
            font-size: 18px;
            font-weight: bold;
        }

        .footer-text {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.4;
        }

        .copyright {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            font-size: 11px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 15px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark);
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .min-length-hint {
            color: #666;
            font-size: 11px;
            margin-top: 4px;
            display: block;
        }

        body.dark-mode {
            background: var(--dark);
            color: var(--light);
        }

        body.dark-mode .tab-content,
        body.dark-mode .modal-content {
            background: var(--dark-gray);
            color: var(--light);
        }

        body.dark-mode .form-input {
            background: #2C3E50;
            border-color: #34495E;
            color: var(--light);
        }

        body.dark-mode .form-label {
            color: var(--light);
        }

        body.dark-mode .field-label {
            color: var(--light);
        }

        body.dark-mode .field-value {
            background: #2C3E50;
            color: var(--light);
        }

        body.dark-mode .transfer-tabs {
            background: #2C3E50;
        }

        #notifications-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 300px;
        }

        .notification {
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 13px;
        }

        .notification-success {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        .notification-error {
            background: linear-gradient(135deg, var(--error), #FF6B81);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-right: 40px;
        }

        .eye-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            padding: 8px;
        }

        @media (max-width: 360px) {
            .logo-text {
                font-size: 18px;
            }
            
            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .auth-btn {
                padding: 6px 15px;
                font-size: 12px;
            }
            
            .welcome-title {
                font-size: 28px;
            }
            
            .user-name {
                font-size: 20px;
            }
            
            .user-balance {
                font-size: 28px;
            }
        }

        @media (max-width: 320px) {
            .header-content {
                padding: 0 10px;
            }
            
            .main-content {
                padding: 0 10px;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="goHome()">
                <div class="logo-icon">$</div>
                <div class="logo-text" data-translate="appName">CashApp</div>
            </div>
            
            <div class="header-controls">
                <button class="control-btn" id="themeToggle" title="تبديل الثيم">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="control-btn" id="languageToggle" title="تبديل اللغة">
                    <i class="fas fa-language"></i>
                </button>
                <button class="auth-btn" id="loginBtn" onclick="openLoginModal()" data-translate="login">
                    تسجيل الدخول
                </button>
                <button class="auth-btn secondary" id="logoutBtn" onclick="logout()" style="display:none;" data-translate="logout">
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </header>

    <div class="main-content" id="mainContent">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <h1 class="welcome-title" data-translate="appName">CashApp</h1>
            <p class="welcome-subtitle" data-translate="appDescription">
                تحويل واستلام الأموال بسهولة وأمان
            </p>
            <button class="auth-btn" onclick="openLoginModal()" style="padding: 12px 30px; font-size: 16px;" data-translate="login">
                تسجيل الدخول
            </button>
        </div>

        <div id="userContent" style="display:none;">
            <div class="user-card">
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name" id="userName">مستخدم</div>
                        <div class="user-balance" id="userBalance">$0.00</div>
                        <div class="user-id" id="userId">ID: 00000000000</div>
                    </div>
                </div>
            </div>

            <div class="transfer-tabs">
                <button class="tab-btn active" onclick="switchTab('transfer')">
                    <i class="fas fa-paper-plane"></i>
                    <span class="tab-text" data-translate="transfer">تحويل</span>
                </button>
                <button class="tab-btn" onclick="switchTab('receive')">
                    <i class="fas fa-qrcode"></i>
                    <span class="tab-text" data-translate="receive">استلام</span>
                </button>
            </div>

            <div class="tab-content active" id="transferTab">
                <div class="form-group">
                    <label class="form-label" for="recipientId" data-translate="recipientId">معرف المستلم</label>
                    <input type="text" id="recipientId" class="form-input" data-translate-placeholder="recipientIdPlaceholder">
                </div>
                <div class="form-group">
                    <label class="form-label" for="transferAmount" data-translate="amount">المبلغ</label>
                    <input type="number" id="transferAmount" class="form-input" step="0.01" data-translate-placeholder="amountPlaceholder">
                </div>
                <button class="submit-btn" onclick="transferMoney()" id="transferBtn">
                    <i class="fas fa-paper-plane"></i>
                    <span class="btn-text" data-translate="transferNow">تحويل الآن</span>
                </button>
            </div>

            <div class="tab-content" id="receiveTab">
                <div class="form-field-group">
                    <div class="field-label" data-translate="username">اسم المستخدم</div>
                    <div class="field-value" id="receiveName">-</div>
                </div>
                <div class="form-field-group">
                    <div class="field-label" data-translate="totalAmount">المبلغ الإجمالي</div>
                    <div class="field-value" id="receiveBalance">$0.00</div>
                </div>
                <div class="form-field-group">
                    <div class="field-label" data-translate="userId">معرف المستخدم</div>
                    <div class="field-value" id="receiveId">-</div>
                </div>
                <p style="color: #666; text-align: center; margin-top: 20px; font-size: 12px;" data-translate="shareId">
                    شارك معرفك مع الآخرين لاستلام الأموال
                </p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <div class="footer-logo-icon">$</div>
                <div class="footer-logo-text" data-translate="appName">CashApp</div>
            </div>
            <p class="footer-text" data-translate="footerDescription">
                تطبيق آمن وسريع لتحويل واستلام الأموال بين المستخدمين
            </p>
            <div class="copyright" data-translate="copyright">
                جميع الحقوق محفوظة لتطبيق CashApp © 2025
            </div>
        </div>
    </footer>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="login">تسجيل الدخول</h3>
                <button class="close-btn" onclick="closeLoginModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="loginUsername" data-translate="username">اسم المستخدم</label>
                <input type="text" id="loginUsername" class="form-input" data-translate-placeholder="usernamePlaceholder">
                <div class="error-message" id="usernameError"></div>
                <span class="min-length-hint" data-translate="usernameHint">الحد الأدنى: 12 حرف</span>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="loginPassword" data-translate="password">كلمة السر</label>
                <div class="input-with-icon">
                    <input type="password" id="loginPassword" class="form-input" data-translate-placeholder="passwordPlaceholder">
                    <button class="eye-btn" onclick="togglePasswordVisibility('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="error-message" id="passwordError"></div>
                <span class="min-length-hint" data-translate="passwordHint">الحد الأدنى: 6 أحرف</span>
            </div>
            
            <button class="submit-btn" onclick="login()" id="loginSubmitBtn">
                <i class="fas fa-sign-in-alt"></i>
                <span data-translate="login">تسجيل الدخول</span>
            </button>
            
            <p style="text-align: center; margin-top: 15px; color: #666; font-size: 12px;" data-translate="loginNote">
                سيتم إنشاء حساب جديد إذا لم يكن موجوداً
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, child, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKGrxv_GT3T3krYeYY5C-o7VmvLkG-gw0",
            authDomain: "cashapp-405b7.firebaseapp.com",
            databaseURL: "https://cashapp-405b7-default-rtdb.firebaseio.com",
            projectId: "cashapp-405b7",
            storageBucket: "cashapp-405b7.firebasestorage.app",
            messagingSenderId: "146496743526",
            appId: "1:146496743526:web:edc0318c7f3affa25465a7",
            measurementId: "G-NWMR38V1B9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.refDB = ref;
        window.childDB = child;
        window.getDB = get;
        window.setDB = set;
        window.updateDB = update;
        window.onValueDB = onValue;
    </script>

    <script>
        // ========== المتغيرات العامة ==========
        let user = null;
        let notificationSystem = null;
        
        // ========== الترجمات الكاملة ==========
        const translations = {
            ar: {
                appName: "CashApp",
                appDescription: "تحويل واستلام الأموال بسهولة وأمان",
                login: "تسجيل الدخول",
                logout: "تسجيل الخروج",
                transfer: "تحويل",
                receive: "استلام",
                transferNow: "تحويل الآن",
                recipientId: "معرف المستلم",
                recipientIdPlaceholder: "معرف المستلم",
                amount: "المبلغ",
                amountPlaceholder: "المبلغ بالدولار",
                username: "اسم المستخدم",
                usernamePlaceholder: "اسم المستخدم",
                password: "كلمة السر",
                passwordPlaceholder: "كلمة السر",
                totalAmount: "المبلغ الإجمالي",
                userId: "معرف المستخدم",
                shareId: "شارك معرفك مع الآخرين لاستلام الأموال",
                usernameHint: "الحد الأدنى: 12 حرف",
                passwordHint: "الحد الأدنى: 6 أحرف",
                loginNote: "سيتم إنشاء حساب جديد إذا لم يكن موجوداً",
                footerDescription: "تطبيق آمن وسريع لتحويل واستلام الأموال بين المستخدمين",
                copyright: "جميع الحقوق محفوظة لتطبيق CashApp © 2025",
                transferSuccess: "تم التحويل بنجاح",
                transferError: "خطأ في التحويل",
                loginSuccess: "تم تسجيل الدخول بنجاح",
                loginError: "خطأ في تسجيل الدخول",
                registerSuccess: "تم إنشاء الحساب بنجاح",
                insufficientBalance: "رصيدك غير كافي",
                invalidRecipient: "الحساب المستهدف غير موجود",
                selfTransfer: "لا يمكن تحويل الأموال إلى نفسك",
                requiredField: "هذا الحقل مطلوب",
                minUsername: "اسم المستخدم يجب أن يكون 12 حرف على الأقل",
                minPassword: "كلمة السر يجب أن تكون 6 أحرف على الأقل",
                invalidAmount: "يرجى إدخال مبلغ صحيح"
            },
            en: {
                appName: "CashApp",
                appDescription: "Transfer and receive money easily and securely",
                login: "Login",
                logout: "Logout",
                transfer: "Transfer",
                receive: "Receive",
                transferNow: "Transfer Now",
                recipientId: "Recipient ID",
                recipientIdPlaceholder: "Recipient ID",
                amount: "Amount",
                amountPlaceholder: "Amount in dollars",
                username: "Username",
                usernamePlaceholder: "Username",
                password: "Password",
                passwordPlaceholder: "Password",
                totalAmount: "Total Amount",
                userId: "User ID",
                shareId: "Share your ID with others to receive money",
                usernameHint: "Minimum: 12 characters",
                passwordHint: "Minimum: 6 characters",
                loginNote: "New account will be created if not exists",
                footerDescription: "Secure and fast app for transferring and receiving money between users",
                copyright: "All rights reserved to CashApp © 2025",
                transferSuccess: "Transfer successful",
                transferError: "Transfer error",
                loginSuccess: "Login successful",
                loginError: "Login error",
                registerSuccess: "Account created successfully",
                insufficientBalance: "Insufficient balance",
                invalidRecipient: "Target account not found",
                selfTransfer: "Cannot transfer money to yourself",
                requiredField: "This field is required",
                minUsername: "Username must be at least 12 characters",
                minPassword: "Password must be at least 6 characters",
                invalidAmount: "Please enter a valid amount"
            }
        };

        // ========== تهيئة التطبيق ==========
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('languageToggle').addEventListener('click', toggleLanguage);
            
            loadPreferences();
            loadUser();
            setupNotifications();
            setupEventListeners();
        });

        // ========== نظام الإشعارات ==========
        function setupNotifications() {
            notificationSystem = {
                notifications: [],
                container: null,
                
                init: function() {
                    this.container = document.createElement('div');
                    this.container.id = 'notifications-container';
                    document.body.appendChild(this.container);
                },
                
                show: function(message, type = 'info', duration = 3000) {
                    if (!this.container) this.init();
                    
                    const id = Date.now();
                    const notification = {
                        id,
                        message,
                        type,
                        duration
                    };
                    
                    this.notifications.push(notification);
                    this.renderNotification(notification);
                    
                    setTimeout(() => {
                        this.remove(id);
                    }, duration);
                    
                    return id;
                },
                
                renderNotification: function(notification) {
                    const div = document.createElement('div');
                    div.className = `notification notification-${notification.type}`;
                    div.dataset.id = notification.id;
                    div.textContent = notification.message;
                    
                    div.onclick = () => this.remove(notification.id);
                    
                    this.container.appendChild(div);
                    
                    setTimeout(() => {
                        if (div.parentNode) {
                            div.style.animation = 'slideOutRight 0.3s ease';
                            setTimeout(() => {
                                if (div.parentNode) div.remove();
                            }, 300);
                        }
                    }, notification.duration);
                },
                
                remove: function(id) {
                    const notification = document.querySelector(`[data-id="${id}"]`);
                    if (notification) {
                        notification.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }
                    
                    this.notifications = this.notifications.filter(n => n.id !== id);
                }
            };
        }

        function showNotification(messageKey, type = 'info') {
            const currentLang = document.documentElement.lang;
            const message = translations[currentLang][messageKey] || messageKey;
            return notificationSystem.show(message, type);
        }

        // ========== إدارة الثيم ==========
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('#themeToggle i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // ========== إدارة اللغة ==========
        function toggleLanguage() {
            const html = document.documentElement;
            const currentLang = html.lang;
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            
            html.lang = newLang;
            html.dir = newLang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('language', newLang);
            
            updateAllTexts(newLang);
        }

        function updateAllTexts(lang) {
            const texts = translations[lang];
            
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (texts[key]) {
                    el.textContent = texts[key];
                }
            });
            
            document.querySelectorAll('[data-translate-placeholder]').forEach(input => {
                const key = input.getAttribute('data-translate-placeholder');
                if (texts[key]) {
                    input.placeholder = texts[key];
                }
            });
            
            document.querySelectorAll('.btn-text').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (texts[key]) {
                    el.textContent = texts[key];
                }
            });
        }

        function loadPreferences() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            }
            
            const savedLang = localStorage.getItem('language') || 'ar';
            document.documentElement.lang = savedLang;
            document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
            updateAllTexts(savedLang);
        }

        // ========== إعداد مستمعات الأحداث ==========
        function setupEventListeners() {
            document.getElementById('loginUsername').addEventListener('input', validateUsername);
            document.getElementById('loginPassword').addEventListener('input', validatePassword);
        }

        function validateUsername() {
            const username = this.value.trim();
            const errorElement = document.getElementById('usernameError');
            const currentLang = document.documentElement.lang;
            
            if (username.length > 0 && username.length < 12) {
                errorElement.textContent = translations[currentLang].minUsername;
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        }

        function validatePassword() {
            const password = this.value.trim();
            const errorElement = document.getElementById('passwordError');
            const currentLang = document.documentElement.lang;
            
            if (password.length > 0 && password.length < 6) {
                errorElement.textContent = translations[currentLang].minPassword;
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        }

        // ========== إدارة المستخدم ==========
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('usernameError').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';
        }

        function togglePasswordVisibility(inputId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = passwordInput.parentElement.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }

        async function hashPassword(password) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Error hashing password:', error);
                throw error;
            }
        }

        function generateUserId() {
            return Math.floor(10000000000 + Math.random() * 90000000000).toString();
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const submitBtn = document.getElementById('loginSubmitBtn');
            const currentLang = document.documentElement.lang;
            
            if (username.length < 12) {
                showNotification('minUsername', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('minPassword', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const hashedPassword = await hashPassword(password);
                let userId = generateUserId();
                
                const usersIndexRef = childDB(refDB(db), 'indexes/users');
                const usersIndex = await getDB(usersIndexRef);
                
                if (usersIndex.exists()) {
                    const indexData = usersIndex.val();
                    for (const [storedUsername, storedUserId] of Object.entries(indexData)) {
                        if (storedUsername === username) {
                            userId = storedUserId;
                            break;
                        }
                    }
                }
                
                const userRef = childDB(refDB(db), 'users/' + userId);
                const snap = await getDB(userRef);
                
                if (!snap.exists()) {
                    await setDB(userRef, {
                        name: username,
                        id: userId,
                        passwordHash: hashedPassword,
                        money: 0,
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    });
                    
                    await updateDB(usersIndexRef, { [username]: userId });
                    
                    user = {
                        name: username,
                        id: userId,
                        passwordHash: hashedPassword,
                        money: 0
                    };
                    
                    showNotification('registerSuccess', 'success');
                } else {
                    const userData = snap.val();
                    
                    if (userData.name !== username) {
                        showNotification('loginError', 'error');
                        return;
                    }
                    
                    if (userData.passwordHash !== hashedPassword) {
                        showNotification('loginError', 'error');
                        return;
                    }
                    
                    user = userData;
                    
                    await updateDB(userRef, { lastLogin: new Date().toISOString() });
                    
                    showNotification('loginSuccess', 'success');
                }
                
                localStorage.setItem('userId', userId);
                localStorage.setItem('userName', username);
                
                updateUI();
                closeLoginModal();
                
                monitorUserData(userId);
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('loginError', 'error');
            } finally {
                submitBtn.disabled = false;
                const currentLang = document.documentElement.lang;
                submitBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> <span>${translations[currentLang].login}</span>`;
            }
        }

        function logout() {
            user = null;
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            updateUI();
            showNotification('logout', 'success');
        }

        async function loadUser() {
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            
            if (userId && userName) {
                try {
                    const userRef = childDB(refDB(db), 'users/' + userId);
                    const snap = await getDB(userRef);
                    
                    if (snap.exists()) {
                        const userData = snap.val();
                        
                        if (userData.name === userName) {
                            user = userData;
                            updateUI();
                            monitorUserData(userId);
                        } else {
                            logout();
                        }
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                }
            }
            
            updateUI();
        }

        function monitorUserData(userId) {
            const userRef = refDB(db, 'users/' + userId);
            
            onValueDB(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    user = snapshot.val();
                    updateUI();
                }
            });
        }

        // ========== تحديث الواجهة ==========
        function updateUI() {
            if (user) {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
                
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userBalance').textContent = '$' + (user.money || 0).toFixed(2);
                document.getElementById('userId').textContent = 'ID: ' + user.id;
                document.getElementById('receiveName').textContent = user.name;
                document.getElementById('receiveBalance').textContent = '$' + (user.money || 0).toFixed(2);
                document.getElementById('receiveId').textContent = user.id;
                
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                
            } else {
                document.getElementById('welcomeScreen').style.display = 'block';
                document.getElementById('userContent').style.display = 'none';
                
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        // ========== إدارة التبويبات ==========
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
        }

        // ========== التحويل ==========
        async function transferMoney() {
            if (!user) {
                showNotification('login', 'error');
                return;
            }
            
            const recipientId = document.getElementById('recipientId').value.trim();
            const amountInput = document.getElementById('transferAmount').value.trim();
            const transferBtn = document.getElementById('transferBtn');
            const currentLang = document.documentElement.lang;
            
            if (!recipientId) {
                document.getElementById('recipientId').focus();
                return;
            }
            
            if (!amountInput) {
                document.getElementById('transferAmount').focus();
                return;
            }
            
            const amount = parseFloat(amountInput);
            if (isNaN(amount) || amount <= 0) {
                showNotification('invalidAmount', 'error');
                document.getElementById('transferAmount').focus();
                return;
            }
            
            if (amount > user.money) {
                showNotification('insufficientBalance', 'error');
                return;
            }
            
            if (recipientId === user.id) {
                showNotification('selfTransfer', 'error');
                return;
            }
            
            transferBtn.disabled = true;
            transferBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const fromRef = refDB(db, 'users/' + user.id);
                const toRef = refDB(db, 'users/' + recipientId);
                
                const [fromSnap, toSnap] = await Promise.all([
                    getDB(fromRef),
                    getDB(toRef)
                ]);
                
                if (!toSnap.exists()) {
                    showNotification('invalidRecipient', 'error');
                    return;
                }
                
                const fromMoney = fromSnap.val().money || 0;
                const toMoney = toSnap.val().money || 0;
                
                if (fromMoney < amount) {
                    showNotification('insufficientBalance', 'error');
                    return;
                }
                
                await Promise.all([
                    updateDB(fromRef, { money: fromMoney - amount }),
                    updateDB(toRef, { money: toMoney + amount })
                ]);
                
                document.getElementById('recipientId').value = '';
                document.getElementById('transferAmount').value = '';
                
                showNotification('transferSuccess', 'success');
                
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('transferError', 'error');
            } finally {
                transferBtn.disabled = false;
                const currentLang = document.documentElement.lang;
                transferBtn.innerHTML = `<i class="fas fa-paper-plane"></i> <span class="btn-text">${translations[currentLang].transferNow}</span>`;
            }
        }

        // ========== وظائف مساعدة ==========
        function goHome() {
            window.location.reload();
        }
    </script>
</body>
</html>
